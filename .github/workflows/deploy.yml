name: Deploy to Railway

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: Install Haskell (Stack)
        uses: haskell/actions/setup@v2
        with:
          ghc-version: '9.10.3'
          enable-stack: true
      
      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            whitemagic-rs/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
          pip install maturin
      
      - name: Build Rust module
        run: |
          cd whitemagic-rs
          maturin develop --release
      
      - name: Build Haskell module (attempt)
        run: |
          cd whitemagic-logic
          stack build || echo "Haskell build failed (non-blocking)"
      
      - name: Run tests
        run: pytest tests/ -v --tb=short
      
      - name: Run Rust benchmarks
        run: |
          PYTHONPATH=. python benchmarks/rust_performance.py || echo "Benchmarks skipped"
  
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/master'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Railway
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: whitemagic-api
          
      - name: Notify deployment
        run: |
          echo "âœ… Deployed to Railway"
          echo "Version: ${GITHUB_REF#refs/tags/}"
