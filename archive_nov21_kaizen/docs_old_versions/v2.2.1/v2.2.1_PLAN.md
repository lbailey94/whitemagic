# v2.2.1 Release Plan

**Version**: 2.2.1 (Incremental Release)  
**Target Date**: 1-2 weeks  
**Focus**: Complete v2.2.1 roadmap + critical infrastructure fixes  
**Status**: Planning

---

## üéØ Goals

1. **Complete missing v2.2.1 features** (documented but not implemented)
2. **Fix critical infrastructure issues** from independent review
3. **Improve SDK compatibility** (low-hanging fruit only)
4. **Add missing tests** for v2.2.1 features

---

## üìã Feature Completion (from v2.2.1 Roadmap)

### Priority 0: Graph Visualization ‚≠ê
**Status**: Documented but not implemented  
**Impact**: Users can create relationships but can't visualize them

**Tasks**:
- [ ] Add `graph` command to CLI (`whitemagic graph <memory>`)
- [ ] Implement ASCII tree visualization using `rich.tree`
- [ ] Add graph traversal logic (BFS with depth limit)
- [ ] Support `--depth N` flag (default: 2)
- [ ] Optional: Export to Mermaid diagram format (`--format mermaid`)
- [ ] Tests for graph traversal and rendering

**Files**:
- Create: `whitemagic/cli_graph.py`
- Update: `whitemagic/cli_app.py` (add graph command)
- Update: `whitemagic/relationships.py` (add traversal helpers)

**Example**:
```bash
whitemagic graph api_design.md --depth 2

API Design
‚îú‚îÄ‚îÄ implements: api_implementation.md
‚îú‚îÄ‚îÄ depends_on: architecture_decision.md
‚îÇ   ‚îî‚îÄ‚îÄ informed_by: requirements.md
‚îî‚îÄ‚îÄ relates_to: testing_strategy.md
```

---

### Priority 1: LLM-Powered Auto-Tagging ü§ñ
**Status**: Currently rule-based only  
**Impact**: Tags are basic (keywords, versions) vs intelligent context-aware

**Tasks**:
- [ ] Add OpenAI integration for tag suggestions
- [ ] Implement fallback: OpenAI ‚Üí local rule-based
- [ ] Add configuration option: `auto_tagger.use_llm` (default: false)
- [ ] Cache LLM suggestions to avoid repeated API calls
- [ ] Tests with mocked OpenAI responses

**Files**:
- Update: `whitemagic/auto_tagger.py` (add LLM provider)
- Update: `whitemagic/config/schema.py` (add auto_tagger config)

---

### Priority 2: Semantic Search Caching üöÄ
**Status**: Not implemented  
**Impact**: Every search re-embeds all memories (slow for large collections)

**Tasks**:
- [ ] File-based embedding cache (`.whitemagic/cache/embeddings/`)
- [ ] Cache key: `hash(file_path + mtime + model_name)`
- [ ] Invalidation: Check mtime on each search
- [ ] Add `--rebuild-cache` flag to force refresh
- [ ] Performance benchmarks (before/after)
- [ ] Tests for cache hit/miss scenarios

**Files**:
- Update: `whitemagic/search/semantic.py` (add caching layer)
- Create: `whitemagic/cache.py` (generic cache manager)

---

### Priority 3: Backup Enhancements üîê
**Status**: Basic backup/restore exists, missing verification  
**Impact**: No way to verify backup integrity

**Tasks**:
- [ ] Add SHA256 hash to backup manifest
- [ ] Verify hashes during restore
- [ ] Incremental backup: Only backup changed files
- [ ] Add `--verify` flag to `backup` command
- [ ] Tests for hash verification and incremental backups

**Files**:
- Update: `whitemagic/backup.py` (add hashing and incremental logic)

---

## üîß Infrastructure Fixes (from Independent Review)

### Priority 0: Dockerfile for Compose üê≥
**Status**: Missing  
**Impact**: `docker compose up` fails immediately

**Tasks**:
- [ ] Create root `Dockerfile` (restore from Dockerfile.backup or rewrite)
- [ ] Test with `docker compose up`
- [ ] Update README with Docker instructions
- [ ] Add to CI/CD pipeline

**Files**:
- Create: `Dockerfile`
- Update: `README.md`, `docs/DEPLOYMENT.md`

---

### Priority 1: Archive API Endpoints üì¶
**Status**: CLI has archive management, API doesn't  
**Impact**: No way to list/restore archived memories via API

**Tasks**:
- [ ] Add `include_archived` query param to `/api/v1/memories`
- [ ] Add `POST /api/v1/memories/{filename}/restore`
- [ ] Add `permanent` query param to DELETE `/api/v1/memories/{filename}`
- [ ] Update OpenAPI schema
- [ ] Add integration tests for archive endpoints

**Files**:
- Update: `whitemagic/api/app.py` (add endpoints)
- Update: `whitemagic/api/routes/*.py` (if needed)

---

### Priority 2: Dashboard Login Fix üîë
**Status**: Email retrieval flow returns 503  
**Impact**: New users can't sign in via email

**Options**:
1. **Remove email flow** from UI (simplest, keep API key only)
2. **Implement email flow** properly (token generation + email sending)
3. **Add warning message** explaining manual API key requirement

**Decision**: Option 1 (remove email flow) for v2.2.1, implement properly in v2.3

**Tasks**:
- [ ] Remove email input from dashboard UI
- [ ] Add clear instructions for API key generation
- [ ] Update dashboard docs

**Files**:
- Update: `dashboard/app.js`
- Update: `docs/DASHBOARD.md`

---

### Priority 3: SDK Header Compatibility üîå
**Status**: SDKs send X-API-Key, API expects Authorization  
**Impact**: Official SDKs cannot connect to API

**Quick Fix for v2.2.1** (full realignment in v2.3):
- [ ] Add `X-API-Key` header support to API (in addition to Authorization)
- [ ] Keep Authorization as primary, X-API-Key as fallback
- [ ] Add deprecation warning in API response for X-API-Key
- [ ] Update SDK READMEs with migration notice

**Files**:
- Update: `whitemagic/api/dependencies.py` (accept both headers)

---

## üß™ Testing Gaps

### Missing Test Coverage:
- [ ] Templates: Create from template, list, show
- [ ] Auto-tagging: Rule-based suggestions, acceptance flow
- [ ] Relationships: relate command, related command, graph traversal
- [ ] Lifecycle: Promotion candidates, importance scoring
- [ ] Stats: Dashboard rendering, metrics calculation
- [ ] Setup wizard: Tier selection, embeddings setup
- [ ] Graph visualization: Tree rendering, depth limiting
- [ ] Archive API: List archived, restore, permanent delete

**Target**: 90%+ coverage for all v2.2.1+ features

---

## üìö Documentation Updates

### Missing/Outdated Docs:
- [ ] Graph command examples in README
- [ ] LLM auto-tagging configuration guide
- [ ] Semantic search caching behavior
- [ ] Docker deployment guide (with new Dockerfile)
- [ ] Archive API endpoint documentation
- [ ] SDK compatibility matrix (which versions work with which API)

---

## üéØ Success Metrics

### Feature Completeness:
- [ ] All v2.2.1 roadmap features implemented
- [ ] Graph visualization works end-to-end
- [ ] LLM auto-tagging available (optional)
- [ ] Semantic search is fast (cached)

### Infrastructure:
- [ ] `docker compose up` succeeds
- [ ] Archive API has feature parity with CLI
- [ ] Dashboard login works OR is clearly removed
- [ ] SDKs can connect to API (at least for basic operations)

### Quality:
- [ ] 90%+ test coverage for new features
- [ ] All regression tests passing
- [ ] Documentation accurate and complete
- [ ] No version inconsistencies

---

## üìÖ Timeline (2 Weeks)

### Week 1: Features
- **Days 1-2**: Graph visualization (graph command, ASCII tree)
- **Days 3-4**: LLM auto-tagging (OpenAI integration)
- **Day 5**: Semantic search caching

### Week 2: Infrastructure + Polish
- **Days 1-2**: Dockerfile + Archive API endpoints
- **Day 3**: Dashboard login fix + SDK header compat
- **Days 4-5**: Testing, documentation, final polish

---

## üö´ Out of Scope for v2.2.1

**Deferred to v2.3.0**:
- Full SDK realignment (endpoint paths, response schemas)
- Dashboard email flow proper implementation
- Mermaid/Graphviz export for graphs (ASCII only in v2.2.1)
- Web-based graph visualization
- Advanced backup features (compression, encryption)

---

## üîÑ Migration Path

### From v2.2.0 ‚Üí v2.2.1:
- No breaking changes
- New features are additive
- Existing configurations continue to work
- Optional LLM auto-tagging (disabled by default)

### Configuration Changes:
```yaml
# New optional config in v2.2.1
auto_tagger:
  use_llm: false  # Set to true to enable LLM-powered tagging
  llm_provider: openai
  model: gpt-3.5-turbo
  
cache:
  embeddings_enabled: true
  cache_dir: ~/.whitemagic/cache
```

---

## üìä Risk Assessment

### Low Risk:
- Graph visualization (new feature, no dependencies)
- Semantic caching (performance optimization, no behavior change)
- Backup enhancements (additive)

### Medium Risk:
- Archive API endpoints (need careful testing)
- SDK header compatibility (might affect existing integrations)

### High Risk:
- LLM auto-tagging (external dependency, API costs)
  - Mitigation: Disabled by default, fallback to rules

---

## ‚úÖ Pre-Release Checklist

- [ ] All features implemented and tested
- [ ] Documentation updated
- [ ] CHANGELOG.md updated
- [ ] Version bumped to 2.2.1 (pyproject.toml, VERSION, package.json)
- [ ] verify_fixes.py updated to check 2.2.1
- [ ] Independent review findings addressed (partial)
- [ ] Manual testing of all new features
- [ ] Build succeeds (`python3 -m build`)
- [ ] Local install works (`pip install dist/*.whl`)
- [ ] All tests pass

---

**Next Steps**: Review this plan, prioritize tasks, and start implementation!
